<?php

namespace Sandbox\ApiBundle\Repository\Log;

use Doctrine\ORM\EntityRepository;

/**
 * LogRepository.
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class LogRepository extends EntityRepository
{
    /**
     * @param $adminId
     * @param $companyId
     * @param $module
     * @param $search
     * @param $key
     * @param $objectId
     * @param $mark
     * @param $startDate
     * @param $endDate
     * @param $platform
     *
     * @return array
     */
    public function getAdminLogs(
        $adminId,
        $startDate,
        $endDate,
        $companyId = null,
        $module = null,
        $search = null,
        $key = null,
        $objectId = null,
        $mark = null,
        $platform = null
    ) {
        $query = $this->createQueryBuilder('l')
            ->where('1=1')
            ->orderBy('l.creationDate', 'DESC');

        if (!is_null($platform)) {
            $query->andWhere('l.platform = :platform')
                ->setParameter('platform', $platform);
        }

        if (!is_null($adminId)) {
            $query->andWhere('l.adminUsername = :adminId')
                ->setParameter('adminId', $adminId);
        }

        if (!is_null($companyId) && !empty($companyId)) {
            $query->andWhere('l.salesCompanyId = :companyId')
                ->setParameter('companyId', $companyId);
        }

        if (!is_null($module) && !empty($module)) {
            $query->andWhere('l.logModule = :logModule')
                ->setParameter('logModule', $module);
        }

        if (!is_null($key) && !empty($key) && !is_null($objectId) && !empty($objectId)) {
            $query->andWhere('l.logObjectKey = :key')
                ->andWhere('l.logObjectId = :objectId')
                ->setParameter('key', $key)
                ->setParameter('objectId', $objectId);
        }

        if (!is_null($search) && !empty($search)) {
            $userQuery = $this->createQueryBuilder('e')
                ->select('DISTINCT up.userId')
                ->from('SandboxApiBundle:User\UserProfile', 'up')
                ->where('up.name LIKE :name')
                ->setParameter('name', "%$search%");

            $users = $userQuery->getQuery()->getResult();
            $userIds = array_map('current', $users);

            $query->leftJoin('l.salesCompany', 'c')
                ->andWhere('
                    (l.adminUsername IN (:userIds) OR
                    c.name LIKE :search OR
                    l.logAction LIKE :search)
                ')
                ->setParameter('search', '%'.$search.'%')
                ->setParameter('userIds', $userIds);
        }

        if (!is_null($mark)) {
            $query->andWhere('l.mark = :mark')
                ->setParameter('mark', $mark);
        }

        if (!is_null($startDate)) {
            $query->andWhere('l.creationDate >= :start')
                ->setParameter('start', $startDate);
        }

        if (!is_null($endDate)) {
            $query->andWhere('l.creationDate <= :end')
                ->setParameter('end', $endDate);
        }

        return $query->getQuery();
    }

    /**
     * @param $module
     * @param $objectKey
     * @param $objectId
     * @param $actions
     *
     * @return array
     */
    public function getLatestAdminLog(
        $module,
        $objectKey,
        $objectId,
        $actions
    ) {
        $query = $this->createQueryBuilder('l')
            ->where('l.id > 0');

        if (!is_null($module)) {
            $query->andWhere('l.logModule = :logModule')
                ->setParameter('logModule', $module);
        }

        if (!is_null($objectKey) && !empty($objectKey) && !is_null($objectId) && !empty($objectId)) {
            $query->andWhere('l.logObjectKey = :key')
                ->andWhere('l.logObjectId = :objectId')
                ->setParameter('key', $objectKey)
                ->setParameter('objectId', $objectId);
        }

        if (!is_null($actions)) {
            $query->andWhere('l.logAction IN (:actions)')
                ->setParameter('actions', $actions);
        }

        $query->setMaxResults(1);
        $query->orderBy('l.creationDate', 'DESC');

        return $query->getQuery()->getOneOrNullResult();
    }

    /**
     * @param $logId
     * @param $module
     * @param $objectKey
     * @param $objectId
     *
     * @return mixed
     *
     * @throws \Doctrine\ORM\NonUniqueResultException
     */
    public function getPreviousLog(
        $logId,
        $module,
        $objectKey,
        $objectId
    ) {
        $query = $this->createQueryBuilder('l')
            ->where('l.logModule = :logModule')
            ->andWhere('l.id < :logId')
            ->andWhere('l.logObjectKey = :key')
            ->andWhere('l.logObjectId = :objectId')
            ->setParameter('logId', $logId)
            ->setParameter('key', $objectKey)
            ->setParameter('objectId', $objectId)
            ->setParameter('logModule', $module)
            ->setMaxResults(1)
            ->orderBy('l.id', 'DESC');

        return $query->getQuery()->getOneOrNullResult();
    }
}
